name: Build manifests

on:
  push:
    paths:
      - 'pages/dashboard/calendar/events/**'
      - '.github/workflows/build-manifests.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate calendar index.json
        shell: bash
        run: |
          set -euo pipefail
          dir="pages/dashboard/calendar/events"
          out="pages/dashboard/calendar/index.json"

          # Collect & sort event filenames (only regular files)
          mapfile -t files < <(find "$dir" -maxdepth 1 -type f -printf '%f\n' | sort)

          # Write JSON without relying on tricky printf escaping
          {
            echo '{'
            echo '  "events": ['
            sep='  '
            for f in "${files[@]}"; do
              echo "${sep}\"$f\""
              sep='  ,'
            done
            echo '  ]'
            echo '}'
          } > "$out"

      - name: Commit & push
        shell: bash
        run: |
          set -e
          git config user.name "gh-actions"
          git config user.email "actions@github.com"
          git add pages/dashboard/calendar/index.json
          git commit -m "chore: rebuild calendar manifest" || echo "No changes"
          git push
